# CloudFormation

AWS クラウド環境内の全インフラリソースを記述してテンプレート化して展開する環境自動設定サービス

- プロビジョニングされたリソースの変更・削除が可能
- 追加リソースへの通常課金のみで追加料金なし
- JSON / YAML で記述する
- クロスリージョンとクロスアカウントで管理
- 直接サポートされていないリソースや機能を利用する場合はカスタムリソースでスタック作成の一部に独自ロジックを組み込むことが可能

## ユースケース

環境構築を正確に実施しかつ効率的に展開したい場合

- AWS リソースの構築を効率化したい
- 開発・テスト・本番環境で利用するインフラを標準化したい
- 毎回同じリソースやプロビジョニング設定を正確に利用したい
- ソフトウェアと同じように環境構成を管理したい

## 構成

テンプレートで定義された内容を読み込んで AWS リソースの集合であるスタックを作成する

- 変更セット
  - スタックの更新を行うときの概要
  - 変更による影響度を確認するためのスタック
  - スタック変更は直接更新と変更セットの実行で可能
- ドリフト
  - テンプレートによって展開した AWS リソースを展開後に変更した場合に、元テンプレートとの差分を検出するチェック機能
- スタックセット
  - 複数の AWS アカウントと複数のリージョンに対してスタックを作成できる機能
- スタック間のリソース参照機能
  - 非参照テンプレートの参照地をエクスポートして値を抽出し、その後参照先のテンプレートのインポートによりリソース参照を行うことで連携したインフラ展開が可能になる機能

## CloudFormation デザイナー

- GUI で視覚的にテンプレートを作成できる

## テンプレート

``` yaml
AWSTemplateFormatVersion: '2010-09-09' テンプレートバージョン
Description: テンプレートの説明 - 書かない場合あり
Metadata: テンプレートに関する追加情報 - 書かない場合あり
Parameters: 実行時に必要なパラメーターとして Keypair やユーザ名などを記述
Mappings: 条件パラメータ値を指定するためのキーと値のマッピングを記述
Conditions: リソース作成時の条件名と条件内容を記述
Transform: サーバレスアプリの SAM バージョンを記述
Resources: 実際にスタックに生成するリソースとその設定プロパティを記述 - メインとなる部分
  FirstVPC: リソースの名称やタイプ・プロパティといった設定内容を以下に記述していく
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      Tags:
      - Key: Name
      - Value: FirstVPC
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      DependOn: リソース間の依存関係を記述
      VpcId: !Ref FirstVPC 組み込み関数：Ref や FindInMap など
      InternetGatewayId: !Ref InternetGateway
OutPuts: スタック構築後に出力させる値や出力先を記述
```
